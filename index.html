<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rojgar Point</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #ffffff; --text: #1F2937; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 90px; height: 100vh; overflow-y: scroll; }

        /* HEADER */
        .header { background: var(--card); padding: 20px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .balance-box { background: linear-gradient(135deg, #4F46E5, #3730A3); color: white; padding: 25px; border-radius: 20px; text-align: center; margin-top: 15px; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3); }
        
        /* ADMIN FAB */
        .admin-fab { position: fixed; bottom: 100px; right: 20px; width: 50px; height: 50px; background: #E11D48; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(225, 29, 72, 0.4); z-index: 9999; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(225, 29, 72, 0); } 100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); } }

        /* TABS */
        .cat-wrapper { margin-top: 20px; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; scrollbar-width: none; }
        .cat-tab { display: inline-flex; align-items: center; gap: 8px; padding: 8px 18px; background: #fff; border: 1px solid #e5e7eb; border-radius: 30px; margin-right: 10px; font-size: 0.9rem; color: #666; cursor: pointer; transition: 0.3s; }
        .cat-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .cat-tab img { width: 18px; height: 18px; border-radius: 50%; }

        /* PAGES */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .task-card { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .task-icon { width: 45px; height: 45px; background: #EEF2FF; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem; }
        .btn-start { background: #EEF2FF; color: var(--primary); padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 0.8rem; border: none; cursor: pointer; }

        /* WALLET */
        .pay-opt { flex: 1; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
        .pay-opt.active { border: 2px solid var(--primary); background: #EEF2FF; color: var(--primary); font-weight: bold; transform: scale(1.02); }
        .w-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 12px; outline: none; font-size: 1rem; }
        .withdraw-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3); margin-bottom: 50px; }

        /* LOADING */
        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #eee; z-index: 1000; }
        .nav-item { text-align: center; color: #999; font-size: 0.75rem; cursor: pointer; width: 25%; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 4px; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div class="admin-fab" id="admin-btn" onclick="window.location.href='admin.html'">
        <i class="fas fa-user-shield" style="font-size: 1.5rem;"></i>
    </div>

    <div class="header">
        <div style="display: flex; gap: 10px; align-items: center;">
            <div style="width: 40px; height: 40px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;" id="u-av">U</div>
            <div>
                <h4 id="u-name">Guest</h4>
                <small style="color: #888;" id="u-id">ID: ...</small>
            </div>
        </div>

        <div class="balance-box">
            <small>Total Balance</small>
            <h1 style="margin: 5px 0;">à§³<span id="u-bal">0.00</span></h1>
        </div>

        <div class="cat-wrapper" id="cat-tabs"></div>
    </div>

    <div id="p-tasks" class="page active">
        <h4 style="margin-bottom: 15px; color: #555;">Task List</h4>
        <div id="task-container">
            <p style="text-align:center; color:#999; margin-top:20px;">Loading tasks...</p>
        </div>
    </div>

    <div id="p-wallet" class="page">
        <h3 style="margin-bottom: 15px;">Withdraw</h3>
        <div style="background: #FEF3C7; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #FDE68A; color: #92400E;">
            <i class="fas fa-info-circle"></i> <span id="w-rules">Loading Rules...</span>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <div class="pay-opt" onclick="setPay('Bkash', this)">Bkash</div>
            <div class="pay-opt" onclick="setPay('Nagad', this)">Nagad</div>
        </div>

        <input type="number" id="w-num" class="w-input" placeholder="Wallet Number">
        <input type="number" id="w-amt" class="w-input" placeholder="Amount">
        <button class="withdraw-btn" onclick="withdraw()">Confirm Request</button>
    </div>

    <div id="p-refer" class="page">
        <div style="text-align: center; background: white; padding: 30px; border-radius: 20px;">
            <i class="fas fa-gift" style="font-size: 4rem; color: var(--primary); margin-bottom: 15px;"></i>
            <h2>Invite Friends</h2>
            <p id="ref-bonus-msg" style="color: #666;">Get bonus per invite!</p>
            <textarea id="ref-link" style="width: 100%; background: #f9f9f9; border: 1px dashed #ccc; padding: 10px; border-radius: 8px; margin: 20px 0; font-family: monospace; resize: none; text-align: center;" readonly>...</textarea>
            <button onclick="copyRef()" style="background: var(--primary); color: white; padding: 12px 25px; border: none; border-radius: 8px; font-weight: 600;">Copy Link</button>
        </div>
        <div style="text-align: center; margin-top: 30px;">
            <div style="background: white; padding: 15px; border-radius: 15px; display: inline-block; width: 45%;">
                <h3><span id="ref-count">0</span></h3>
                <small>Joins</small>
            </div>
            <div style="background: white; padding: 15px; border-radius: 15px; display: inline-block; width: 45%;">
                <h3 style="color: #10B981;">à§³<span id="ref-earn">0</span></h3>
                <small>Earned</small>
            </div>
        </div>
    </div>

    <div id="p-profile" class="page">
        <h3>Settings</h3>
        <div style="background: white; border-radius: 15px; overflow: hidden; margin-top: 15px;">
            <div class="task-card" onclick="editName()" style="margin:0; border-radius:0; border-bottom:1px solid #eee;">
                <span><i class="fas fa-edit" style="color:#666; width:25px;"></i> Edit Name</span>
                <i class="fas fa-chevron-right" style="color:#ccc;"></i>
            </div>
            <div class="task-card" onclick="openSupport()" style="margin:0; border-radius:0;">
                <span><i class="fas fa-headset" style="color:#666; width:25px;"></i> Support</span>
                <i class="fas fa-chevron-right" style="color:#ccc;"></i>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="nav('p-tasks', this)"><i class="fas fa-home"></i>Home</div>
        <div class="nav-item" onclick="nav('p-wallet', this)"><i class="fas fa-wallet"></i>Wallet</div>
        <div class="nav-item" onclick="nav('p-refer', this)"><i class="fas fa-users"></i>Refer</div>
        <div class="nav-item" onclick="nav('p-profile', this)"><i class="fas fa-user"></i>Profile</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxRuQsi36v3uT-IRXqbls4OBA9PVddqiM",
            authDomain: "telegram-mini-apps-2cc3c.firebaseapp.com",
            databaseURL: "https://telegram-mini-apps-2cc3c-default-rtdb.firebaseio.com",
            projectId: "telegram-mini-apps-2cc3c",
            storageBucket: "telegram-mini-apps-2cc3c.firebasestorage.app",
            messagingSenderId: "819238200908",
            appId: "1:819238200908:web:3f97d8de37d8b46c0936e9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- ADMIN ID ---
        const ADMIN_ID = "8391024974"; 
        const BOT_USERNAME = "Rojgar_Point_bot";
        const BOT_TOKEN = "8280244541:AAE8SP9L9QzfBXIEBVatzLQdV9nNjpEhcV8";

        let user = null, settings = {}, activeCat = 'all', payMethod = '';

        window.tg = window.Telegram.WebApp;
        window.tg.expand();

        async function init() {
            let uid = localStorage.getItem('web_uid');
            let name = "Guest";
            let refBy = null;

            if (window.tg.initDataUnsafe && window.tg.initDataUnsafe.user) {
                const u = window.tg.initDataUnsafe.user;
                uid = u.id.toString();
                name = u.first_name;
                refBy = window.tg.initDataUnsafe.start_param;
            } else if (!uid) {
                uid = "web_" + Date.now();
                localStorage.setItem('web_uid', uid);
            }

            const uRef = ref(db, 'users/' + uid);
            onValue(uRef, (snap) => {
                if(snap.exists()) {
                    user = snap.val();
                    updateUI();
                } else {
                    user = { id: uid, name: name, balance: 0, refCount: 0, refEarn: 0, completed: {} };
                    if(refBy && refBy !== uid) {
                         get(ref(db, 'users/'+refBy)).then(rSnap => {
                             if(rSnap.exists()) {
                                 get(ref(db, 'settings')).then(sSnap => {
                                     const bonus = sSnap.exists() ? (sSnap.val().referBonus || 0) : 0;
                                     update(ref(db, 'users/'+refBy), {
                                         balance: parseFloat(rSnap.val().balance) + parseFloat(bonus),
                                         refCount: (rSnap.val().refCount || 0) + 1,
                                         refEarn: (rSnap.val().refEarn || 0) + parseFloat(bonus)
                                     });
                                     fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_ID}&text=ðŸš€ New Refer: ${name} by ${rSnap.val().name}`);
                                 });
                             }
                         });
                    }
                    set(uRef, user);
                    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_ID}&text=ðŸ‘¤ New User: ${name} (${uid})`);
                }
                document.getElementById('loader').style.display = 'none';
            });
            loadData();
        }

        function updateUI() {
            document.getElementById('u-name').innerText = user.name;
            document.getElementById('u-id').innerText = "ID: " + user.id;
            document.getElementById('u-av').innerText = user.name.charAt(0);
            document.getElementById('u-bal').innerText = parseFloat(user.balance).toFixed(2);
            document.getElementById('ref-link').value = `https://t.me/${BOT_USERNAME}?start=${user.id}`;
            document.getElementById('ref-count').innerText = user.refCount || 0;
            document.getElementById('ref-earn').innerText = parseFloat(user.refEarn || 0).toFixed(2);
            
            // AUTO ADMIN
            if(String(user.id) === String(ADMIN_ID)) {
                document.getElementById('admin-btn').style.display = 'flex';
            }
        }

        function loadData() {
            onValue(ref(db, 'settings'), snap => {
                if(snap.exists()) {
                    settings = snap.val();
                    const popKey = 'pop_' + new Date().getDate();
                    if(settings.popupMsg && !sessionStorage.getItem(popKey)) {
                         Swal.fire({ title: 'ðŸ“¢ Notice', text: settings.popupMsg, confirmButtonColor: '#4F46E5' });
                         sessionStorage.setItem(popKey, 'true');
                    }
                    document.getElementById('w-rules').innerText = `Min Withdraw: à§³${settings.minWithdraw} | Min Refers: ${settings.minRefer}`;
                    document.getElementById('ref-bonus-msg').innerText = `Earn à§³${settings.referBonus} per invite!`;
                }
            });

            onValue(ref(db, 'categories'), snap => {
                const tabs = document.getElementById('cat-tabs');
                tabs.innerHTML = `<div class="cat-tab active" onclick="setCat('all', this)">All</div>`;
                if(snap.exists()) {
                    const cats = snap.val();
                    Object.keys(cats).forEach(key => {
                        const c = cats[key];
                        let icon = c.icon.includes('http') ? `<img src="${c.icon}">` : `<i class="${c.icon}"></i>`;
                        tabs.innerHTML += `<div class="cat-tab" onclick="setCat('${key}', this)">${icon} ${c.name}</div>`;
                    });
                }
            });

            onValue(ref(db, 'tasks'), snap => {
                renderTasks(snap.exists() ? snap.val() : {});
            });
        }

        function renderTasks(tasks) {
            const list = document.getElementById('task-container');
            list.innerHTML = '';
            let count = 0;
            const completed = user && user.completed ? user.completed : {};

            Object.keys(tasks).forEach(key => {
                const t = tasks[key];
                if((activeCat === 'all' || t.category === activeCat) && !completed[key]) {
                    count++;
                    list.innerHTML += `
                    <div class="task-card">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="task-icon"><i class="fas fa-star"></i></div>
                            <div>
                                <div style="font-weight:600;">${t.title}</div>
                                <small style="color:#4F46E5;">+à§³${t.reward}</small>
                            </div>
                        </div>
                        <button class="btn-start" onclick="doTask('${key}', ${t.reward}, '${t.link}')">Start</button>
                    </div>`;
                }
            });
            if(count === 0) list.innerHTML = "<p style='text-align:center;color:#94a3b8;margin-top:20px;'>No tasks available</p>";
        }

        window.setCat = function(cat, el) {
            activeCat = cat;
            document.querySelectorAll('.cat-tab').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            get(ref(db, 'tasks')).then(snap => renderTasks(snap.exists() ? snap.val() : {}));
        }

        window.doTask = async function(tid, rew, link) {
            window.open(link, '_blank');
            const newBal = parseFloat(user.balance) + parseFloat(rew);
            const updates = {};
            updates['users/'+user.id+'/balance'] = newBal;
            updates['users/'+user.id+'/completed/'+tid] = true;
            await update(ref(db), updates);
            Swal.fire({toast:true, icon:'success', title:'Reward Added!', showConfirmButton:false, timer:1500});
        }

        window.setPay = function(m, el) {
            payMethod = m;
            document.querySelectorAll('.pay-opt').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        }

        window.withdraw = async function() {
            const num = document.getElementById('w-num').value;
            const amt = parseFloat(document.getElementById('w-amt').value);

            if(!payMethod) return Swal.fire('Error', 'Select Method', 'error');
            if(!num || !amt) return Swal.fire('Error', 'Fill all fields', 'error');
            if(amt < settings.minWithdraw) return Swal.fire('Error', 'Min Withdraw: '+settings.minWithdraw, 'error');
            if(user.refCount < settings.minRefer) return Swal.fire('Error', 'Need Refers: '+settings.minRefer, 'error');
            if(amt > user.balance) return Swal.fire('Error', 'Low Balance', 'error');

            const rid = Date.now();
            await set(ref(db, 'withdraws/'+rid), {
                id: rid, userId: user.id, userName: user.name, amount: amt, number: num, method: payMethod, status: 'pending', date: new Date().toLocaleString()
            });
            await update(ref(db, 'users/'+user.id), { balance: user.balance - amt });
            
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_ID}&text=ðŸ’¸ Withdraw Request: à§³${amt} (${payMethod}) by ${user.name}`);
            Swal.fire('Success', 'Request Sent!', 'success');
        }

        // --- SUPPORT LINK LOGIC ---
        window.openSupport = function() {
            if(settings.supportLink) {
                window.open(settings.supportLink, '_blank');
            } else {
                Swal.fire('Info', 'Support link not set', 'info');
            }
        }

        window.copyRef = function() {
            var copyText = document.getElementById("ref-link");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                Swal.fire({toast:true, icon:'success', title:'Copied!', position:'top', showConfirmButton:false, timer:1000});
            } catch (err) {
                navigator.clipboard.writeText(copyText.value);
            }
        }

        window.editName = async function() {
            const {value:n} = await Swal.fire({title:'Edit Name', input:'text'});
            if(n) await update(ref(db, 'users/'+user.id), { name: n });
        }

        window.nav = function(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        init();
    </script>
</body>
</html>
